name: Compile LaTeX with Claude Code

on:
  workflow_dispatch:
    inputs:
      subdir:
        description: 'Subdirectory under .research/latex/ (e.g., iclr2025)'
        required: true
      iteration_id:
        description: "Iteration ID to use"
        required: true

permissions:
  id-token: write
  contents: write

defaults:
  run:
    shell: bash

env:
  LATEX_DIR: .research/latex/${{ github.event.inputs.subdir }}
  CHKTEX_COMMAND: |
    set -e
    echo "=== [PHASE 1/2] Running ChkTeX... ==="
    chktex -q paper.tex
  COMPILE_COMMAND: |
    set -e
    echo "=== [PHASE 2/2] Compiling LaTeX document... ==="
    pdflatex -interaction=nonstopmode paper.tex
    bibtex paper
    pdflatex -interaction=nonstopmode paper.tex
    pdflatex -interaction=nonstopmode paper.tex
  PROMPT: |
    You are a fully autonomous AI assistant specializing in LaTeX document correction.
    Your task is to ensure the LaTeX paper is free of chktex warnings and compiles successfully into a PDF. You will achieve this by executing, analyzing, fixing, and re-validating the document.
    You have been granted full tool access.

    Guiding Principles:
    - Scope: Do not perform any Git operations like commit or push. Your sole responsibility is to make the LaTeX document compilable.
    - Method: When fixing errors, you MUST only modify existing files. Do not create new files.
    - Minimal Edits: You MUST limit your changes to the absolute minimum required to fix LaTeX syntax, chktex warnings, or compilation errors.
    - Autonomy: Execute all steps autonomously without asking for permission.

    Procedure:
    1.  Change Directory: First, change your working directory to `$LATEX_DIR`. All subsequent commands MUST be run from this directory.
    2.  Run ChkTeX: Execute the command `bash -c "$CHKTEX_COMMAND"`.
    3.  Analyze & Fix ChkTeX: If the command fails, you MUST analyze the chktex warnings from the output, fix the `paper.tex` file, and repeat step 2 until it passes.
    4.  Run LaTeX Compile: Once chktex passes, execute `bash -c "$COMPILE_COMMAND"`.
    5.  Analyze & Fix Compilation: If compilation fails, you MUST analyze the LaTeX errors (e.g., undefined control sequences, missing files, bad boxes), fix the `.tex` files, and repeat step 4 until it succeeds.
    6.  Completion: Once both phases are complete, the task is finished.
 

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install LaTeX, ChkTeX, and other dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            chktex \
            texlive-base \
            texlive-latex-recommended \
            texlive-fonts-recommended \
            texlive-latex-extra \
            texlive-science

      - name: Copy experiment images to LaTeX directory
        run: |
          ITER_DIR=".research/iteration${{ inputs.iteration_id }}"
          echo "Using iteration: $ITER_DIR"

          if [ ! -d "$ITER_DIR" ]; then
            echo "Iteration directory $ITER_DIR not found."
            exit 1
          fi

          echo "Copying images from $ITER_DIR"
          mkdir -p "${LATEX_DIR}/images"

          find "$ITER_DIR" -mindepth 2 -maxdepth 2 -type f -name "*.pdf" \
            -exec cp {} "${LATEX_DIR}/images/" \;

          echo "Image copy completed. Files in images/:"
          ls -la "${LATEX_DIR}/images/" || echo "No images found"

      - name: Upload prepard workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace-${{ github.run_id }}
          path: .

  claude-code-1:
    name: Run Claude Code (Attempt 1)
    needs: setup
    timeout-minutes: 20
    uses: ./.github/workflows/reusable_claude_code.yml
    secrets: inherit
    with:
      prompt: ${{ env.PROMPT }}

  claude-code-2:
    name: Run Claude Code (Attempt 2)
    needs: claude-code-1
    if: failure()
    timeout-minutes: 20
    uses: ./.github/workflows/reusable_claude_code.yml
    secrets: inherit
    with:
      prompt: ${{ env.PROMPT }}

  claude-code-3:
    name: Run Claude Code (Attempt 3)
    needs: claude-code-2
    if: failure()
    timeout-minutes: 20
    uses: ./.github/workflows/reusable_claude_code.yml
    secrets: inherit
    with:
      prompt: ${{ env.PROMPT }}

  finalize:
    name: Commit and Push PDF
    needs: [claude-code-1, claude-code-2, claude-code-3]
    if: >-
      !cancelled() && (
        needs.claude-code-1.result == 'success' ||
        needs.claude-code-2.result == 'success' ||
        needs.claude-code-3.result == 'success'
      )
    steps:
      - name: Download fixed workspace
        uses: actions/download-artifact@v4
        with:
          name: workspace-${{ github.run_id }}

      - name: Move compiled PDF to .research/
        run: |
          src="${LATEX_DIR}/paper.pdf"
          dest=".research/paper.pdf"
          if [ -f "$src" ]; then
            mv "$src" "$dest"
            echo "Successfully moved compiled PDF to $dest"
          else
            echo "Warning: Compiled PDF not found at $src"
            exit 1
          fi

      - name: Commit and push LaTeX outputs
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git add .

          if ! git diff --staged --quiet; then
            git commit -m "[CI] Autonomous LaTeX fixes and compilation for ${{ github.event.inputs.subdir }}"
            for i in {1..5}; do
              git push && break
              echo "Push failed on attempt $i. Retrying in $((2**i)) seconds..."
              sleep $((2**i))
            done
          else
            echo "No changes were made by the agent."
          fi
